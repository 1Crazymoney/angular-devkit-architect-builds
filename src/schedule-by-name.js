"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
const core_1 = require("@angular-devkit/core");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const api_1 = require("./api");
const progressSchema = require('./progress-schema.json');
let _uniqueId = 0;
async function scheduleByName(name, buildOptions, options) {
    const childLoggerName = options.target ? `{${api_1.targetStringFromTarget(options.target)}}` : name;
    const logger = options.logger.createChild(childLoggerName);
    const job = options.scheduler.schedule(name, {});
    let stateSubscription;
    const workspaceRoot = await options.workspaceRoot;
    const currentDirectory = await options.currentDirectory;
    const description = await job.description.toPromise();
    const info = description.info;
    const id = ++_uniqueId;
    const message = Object.assign({ id, currentDirectory: workspaceRoot, workspaceRoot: currentDirectory, info: info, options: buildOptions }, (options.target ? { target: options.target } : {}));
    // Wait for the job to be ready.
    if (job.state !== core_1.experimental.jobs.JobState.Started) {
        stateSubscription = job.outboundBus.subscribe(event => {
            if (event.kind === core_1.experimental.jobs.JobOutboundMessageKind.Start) {
                job.input.next(message);
            }
        }, () => { });
    }
    else {
        job.input.next(message);
    }
    const logChannelSub = job.getChannel('log').subscribe(entry => {
        logger.next(entry);
    }, () => { });
    const s = job.outboundBus.subscribe({
        error() { },
        complete() {
            s.unsubscribe();
            logChannelSub.unsubscribe();
            if (stateSubscription) {
                stateSubscription.unsubscribe();
            }
        },
    });
    const output = job.output.pipe(operators_1.map(output => (Object.assign({}, output, options.target ? { target: options.target } : 0, { info }))), operators_1.shareReplay());
    // Start the builder.
    output.pipe(operators_1.first()).subscribe({
        error() { },
    });
    return {
        id,
        info,
        // This is a getter so that it always returns the next output, and not the same one.
        get result() { return output.pipe(operators_1.first()).toPromise(); },
        output,
        progress: job.getChannel('progress', progressSchema).pipe(operators_1.shareReplay(1)),
        stop() {
            job.stop();
            return job.outboundBus.pipe(operators_1.ignoreElements(), operators_1.catchError(() => rxjs_1.EMPTY)).toPromise();
        },
    };
}
exports.scheduleByName = scheduleByName;
async function scheduleByTarget(target, overrides, options) {
    return scheduleByName(`{${api_1.targetStringFromTarget(target)}}`, overrides, Object.assign({}, options, { target, logger: options.logger }));
}
exports.scheduleByTarget = scheduleByTarget;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NoZWR1bGUtYnktbmFtZS5qcyIsInNvdXJjZVJvb3QiOiIuLyIsInNvdXJjZXMiOlsicGFja2FnZXMvYW5ndWxhcl9kZXZraXQvYXJjaGl0ZWN0L3NyYy9zY2hlZHVsZS1ieS1uYW1lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7OztHQU1HO0FBQ0gsK0NBQW1FO0FBQ25FLCtCQUEyQztBQUMzQyw4Q0FBaUc7QUFDakcsK0JBT2U7QUFFZixNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsd0JBQXdCLENBQUMsQ0FBQztBQUd6RCxJQUFJLFNBQVMsR0FBRyxDQUFDLENBQUM7QUFFWCxLQUFLLFVBQVUsY0FBYyxDQUNsQyxJQUFZLEVBQ1osWUFBNkIsRUFDN0IsT0FNQztJQUVELE1BQU0sZUFBZSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksNEJBQXNCLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUM5RixNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUMzRCxNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBa0MsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ2xGLElBQUksaUJBQStCLENBQUM7SUFFcEMsTUFBTSxhQUFhLEdBQUcsTUFBTSxPQUFPLENBQUMsYUFBYSxDQUFDO0lBQ2xELE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxPQUFPLENBQUMsZ0JBQWdCLENBQUM7SUFFeEQsTUFBTSxXQUFXLEdBQUcsTUFBTSxHQUFHLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQ3RELE1BQU0sSUFBSSxHQUFHLFdBQVcsQ0FBQyxJQUFtQixDQUFDO0lBQzdDLE1BQU0sRUFBRSxHQUFHLEVBQUUsU0FBUyxDQUFDO0lBRXZCLE1BQU0sT0FBTyxtQkFDWCxFQUFFLEVB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Q3BDLE1BQWMsRUFDZCxTQUEwQixFQUMxQixPQUtDO0lBRUQsT0FBTyxjQUFjLENBQUMsSUFBSSw0QkFBc0IsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLFNBQVMsb0JBQ2pFLE9BQU8sSUFDVixNQUFNLEVBQ04sTUFBTSxFQUFFLE9BQU8sQ0FBQyxNQUFNLElBQ3RCLENBQUM7QUFDTCxDQUFDO0FBZkQsNENBZUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5pbXBvcnQgeyBleHBlcmltZW50YWwsIGpzb24sIGxvZ2dpbmcgfSBmcm9tICdAYW5ndWxhci1kZXZraXQvY29yZSc7XG5pbXBvcnQgeyBFTVBUWSwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCBmaXJzdCwgaWdub3JlRWxlbWVudHMsIG1hcCwgc2hhcmUsIHNoYXJlUmVwbGF5LCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1xuICBCdWlsZGVySW5mbyxcbiAgQnVpbGRlcklucHV0LFxuICBCdWlsZGVyT3V0cHV0LCBCdWlsZGVyUHJvZ3Jlc3NSZXBvcnQsXG4gIEJ1aWxkZXJSdW4sXG4gIFRhcmdldCxcbiAgdGFyZ2V0U3RyaW5nRnJvbVRhcmdldCxcbn0gZnJvbSAnLi9hcGknO1xuXG5jb25zdCBwcm9ncmVzc1NjaGVtYSA9IHJlcXVpcmUoJy4vcHJvZ3Jlc3Mtc2NoZW1hLmpzb24nKTtcblxuXG5sZXQgX3VuaXF1ZUlkID0gMDtcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNjaGVkdWxlQnlOYW1lKFxuICBuYW1lOiBzdHJpbmcsXG4gIGJ1aWxkT3B0aW9uczoganNvbi5Kc29uT2JqZWN0LFxuICBvcHRpb25zOiB7XG4gICAgdGFyZ2V0PzogVGFyZ2V0LFxuICAgIHNjaGVkdWxlcjogZXhwZXJpbWVudGFsLmpvYnMuU2NoZWR1bGVyLFxuICAgIGxvZ2dlcjogbG9nZ2luZy5Mb2dnZXJBcGksXG4gICAgd29ya3NwYWNlUm9vdDogc3RyaW5nIHwgUHJvbWlzZTxzdHJpbmc+LFxuICAgIGN1cnJlbnREaXJlY3Rvcnk6IHN0cmluZyB8IFByb21pc2U8c3RyaW5nPixcbiAgfSxcbik6IFByb21pc2U8QnVpbGRlclJ1bj4ge1xuICBjb25zdCBjaGlsZExvZ2dlck5hbWUgPSBvcHRpb25zLnRhcmdldCA/IGB7JHt0YXJnZXRTdHJpbmdGcm9tVGFyZ2V0KG9wdGlvbnMudGFyZ2V0KX19YCA6IG5hbWU7XG4gIGNvbnN0IGxvZ2dlciA9IG9wdGlvbnMubG9nZ2VyLmNyZWF0ZUNoaWxkKGNoaWxkTG9nZ2VyTmFtZSk7XG4gIGNvbnN0IGpvYiA9IG9wdGlvbnMuc2NoZWR1bGVyLnNjaGVkdWxlPHt9LCBCdWlsZGVySW5wdXQsIEJ1aWxkZXJPdXRwdXQ+KG5hbWUsIHt9KTtcbiAgbGV0IHN0YXRlU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG5cbiAgY29uc3Qgd29ya3NwYWNlUm9vdCA9IGF3YWl0IG9wdGlvbnMud29ya3NwYWNlUm9vdDtcbiAgY29uc3QgY3VycmVudERpcmVjdG9yeSA9IGF3YWl0IG9wdGlvbnMuY3VycmVudERpcmVjdG9yeTtcblxuICBjb25zdCBkZXNjcmlwdGlvbiA9IGF3YWl0IGpvYi5kZXNjcmlwdGlvbi50b1Byb21pc2UoKTtcbiAgY29uc3QgaW5mbyA9IGRlc2NyaXB0aW9uLmluZm8gYXMgQnVpbGRlckluZm87XG4gIGNvbnN0IGlkID0gKytfdW5pcXVlSWQ7XG5cbiAgY29uc3QgbWVzc2FnZSA9IHtcbiAgICBpZCxcbiAgICBjdXJyZW50RGlyZWN0b3J5OiB3b3Jrc3BhY2VSb290LFxuICAgIHdvcmtzcGFjZVJvb3Q6IGN1cnJlbnREaXJlY3RvcnksXG4gICAgaW5mbzogaW5mbyxcbiAgICBvcHRpb25zOiBidWlsZE9wdGlvbnMsXG4gICAgLi4uKG9wdGlvbnMudGFyZ2V0ID8geyB0YXJnZXQ6IG9wdGlvbnMudGFyZ2V0IH0gOiB7fSksXG4gIH07XG5cbiAgLy8gV2FpdCBmb3IgdGhlIGpvYiB0byBiZSByZWFkeS5cbiAgaWYgKGpvYi5zdGF0ZSAhPT0gZXhwZXJpbWVudGFsLmpvYnMuSm9iU3RhdGUuU3RhcnRlZCkge1xuICAgIHN0YXRlU3Vic2NyaXB0aW9uID0gam9iLm91dGJvdW5kQnVzLnN1YnNjcmliZShldmVudCA9PiB7XG4gICAgICBpZiAoZXZlbnQua2luZCA9PT0gZXhwZXJpbWVudGFsLmpvYnMuSm9iT3V0Ym91bmRNZXNzYWdlS2luZC5TdGFydCkge1xuICAgICAgICBqb2IuaW5wdXQubmV4dChtZXNzYWdlKTtcbiAgICAgIH1cbiAgICB9LCAoKSA9PiB7fSk7XG4gIH0gZWxzZSB7XG4gICAgam9iLmlucHV0Lm5leHQobWVzc2FnZSk7XG4gIH1cblxuICBjb25zdCBsb2dDaGFubmVsU3ViID0gam9iLmdldENoYW5uZWw8bG9nZ2luZy5Mb2dFbnRyeT4oJ2xvZycpLnN1YnNjcmliZShlbnRyeSA9PiB7XG4gICAgbG9nZ2VyLm5leHQoZW50cnkpO1xuICB9LCAoKSA9PiB7fSk7XG5cbiAgY29uc3QgcyA9IGpvYi5vdXRib3VuZEJ1cy5zdWJzY3JpYmUoe1xuICAgIGVycm9yKCkge30sXG4gICAgY29tcGxldGUoKSB7XG4gICAgICBzLnVuc3Vic2NyaWJlKCk7XG4gICAgICBsb2dDaGFubmVsU3ViLnVuc3Vic2NyaWJlKCk7XG4gICAgICBpZiAoc3RhdGVTdWJzY3JpcHRpb24pIHtcbiAgICAgICAgc3RhdGVTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgIH1cbiAgICB9LFxuICB9KTtcbiAgY29uc3Qgb3V0cHV0ID0gam9iLm91dHB1dC5waXBlKFxuICAgIG1hcChvdXRwdXQgPT4gKHtcbiAgICAgIC4uLm91dHB1dCxcbiAgICAgIC4uLm9wdGlvbnMudGFyZ2V0ID8geyB0YXJnZXQ6IG9wdGlvbnMudGFyZ2V0IH0gOiAwLFxuICAgICAgaW5mbyxcbiAgICB9IGFzIEJ1aWxkZXJPdXRwdXQpKSxcbiAgICBzaGFyZVJlcGxheSgpLFxuICApO1xuXG4gIC8vIFN0YXJ0IHRoZSBidWlsZGVyLlxuICBvdXRwdXQucGlwZShmaXJzdCgpKS5zdWJzY3JpYmUoe1xuICAgIGVycm9yKCkge30sXG4gIH0pO1xuXG4gIHJldHVybiB7XG4gICAgaWQsXG4gICAgaW5mbyxcbiAgICAvLyBUaGlzIGlzIGEgZ2V0dGVyIHNvIHRoYXQgaXQgYWx3YXlzIHJldHVybnMgdGhlIG5leHQgb3V0cHV0LCBhbmQgbm90IHRoZSBzYW1lIG9uZS5cbiAgICBnZXQgcmVzdWx0KCkgeyByZXR1cm4gb3V0cHV0LnBpcGUoZmlyc3QoKSkudG9Qcm9taXNlKCk7IH0sXG4gICAgb3V0cHV0LFxuICAgIHByb2dyZXNzOiBqb2IuZ2V0Q2hhbm5lbDxCdWlsZGVyUHJvZ3Jlc3NSZXBvcnQ+KCdwcm9ncmVzcycsIHByb2dyZXNzU2NoZW1hKS5waXBlKFxuICAgICAgc2hhcmVSZXBsYXkoMSksXG4gICAgKSxcbiAgICBzdG9wKCkge1xuICAgICAgam9iLnN0b3AoKTtcblxuICAgICAgcmV0dXJuIGpvYi5vdXRib3VuZEJ1cy5waXBlKFxuICAgICAgICBpZ25vcmVFbGVtZW50cygpLFxuICAgICAgICBjYXRjaEVycm9yKCgpID0+IEVNUFRZKSxcbiAgICAgICkudG9Qcm9taXNlKCk7XG4gICAgfSxcbiAgfTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNjaGVkdWxlQnlUYXJnZXQoXG4gIHRhcmdldDogVGFyZ2V0LFxuICBvdmVycmlkZXM6IGpzb24uSnNvbk9iamVjdCxcbiAgb3B0aW9uczoge1xuICAgIHNjaGVkdWxlcjogZXhwZXJpbWVudGFsLmpvYnMuU2NoZWR1bGVyLFxuICAgIGxvZ2dlcjogbG9nZ2luZy5Mb2dnZXJBcGksXG4gICAgd29ya3NwYWNlUm9vdDogc3RyaW5nIHwgUHJvbWlzZTxzdHJpbmc+LFxuICAgIGN1cnJlbnREaXJlY3Rvcnk6IHN0cmluZyB8IFByb21pc2U8c3RyaW5nPixcbiAgfSxcbik6IFByb21pc2U8QnVpbGRlclJ1bj4ge1xuICByZXR1cm4gc2NoZWR1bGVCeU5hbWUoYHske3RhcmdldFN0cmluZ0Zyb21UYXJnZXQodGFyZ2V0KX19YCwgb3ZlcnJpZGVzLCB7XG4gICAgLi4ub3B0aW9ucyxcbiAgICB0YXJnZXQsXG4gICAgbG9nZ2VyOiBvcHRpb25zLmxvZ2dlcixcbiAgfSk7XG59XG4iXX0=